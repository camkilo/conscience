<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conscience - 3D Game</title>
    
    <!-- Import map for ES modules -->
    <script type="importmap">
    {
        "imports": {
            "three": "/three/three.module.js",
            "three/": "/three-jsm/"
        }
    }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            background: #000;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
        }

        #loading-screen h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(68, 136, 255, 0.8);
        }

        #loading-screen p {
            font-size: 18px;
            margin: 10px 0;
            opacity: 0.8;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(68, 136, 255, 0.3);
            border-top-color: #4488ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px 0;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-family: 'Courier New', monospace;
        }

        #start-overlay h1 {
            font-size: 72px;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.8);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        #start-overlay .description {
            max-width: 600px;
            text-align: center;
            font-size: 16px;
            line-height: 1.6;
            margin: 20px;
            opacity: 0.9;
        }

        #start-overlay .features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
            max-width: 700px;
        }

        #start-overlay .feature {
            background: rgba(68, 136, 255, 0.1);
            border: 1px solid rgba(68, 136, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            font-size: 14px;
        }

        #start-overlay .feature strong {
            color: #4488ff;
            display: block;
            margin-bottom: 5px;
        }

        #start-btn {
            padding: 20px 60px;
            font-size: 24px;
            background: linear-gradient(135deg, #00ff88 0%, #4488ff 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin-top: 30px;
            transition: all 0.3s;
            box-shadow: 0 5px 30px rgba(68, 136, 255, 0.5);
        }

        #start-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 40px rgba(68, 136, 255, 0.8);
        }

        #back-to-menu {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: rgba(68, 136, 255, 0.3);
            color: white;
            border: 2px solid #4488ff;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            z-index: 1001;
            text-decoration: none;
            display: none;
            pointer-events: all;
        }

        #back-to-menu:hover {
            background: rgba(68, 136, 255, 0.5);
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <h1>‚ö° CONSCIENCE ‚ö°</h1>
        <div class="loader"></div>
        <p>Loading 3D Engine...</p>
        <p style="font-size: 14px; margin-top: 20px;">Powered by Three.js</p>
    </div>

    <!-- Start Overlay -->
    <div id="start-overlay" class="hidden">
        <h1>‚ö° CONSCIENCE ‚ö°</h1>
        <div class="description">
            Welcome to the 3D Predictive World. The game watches your every move, 
            learns your patterns, and adapts in real-time. Face adaptive enemies, 
            make moral choices, and survive in a world that knows you.
        </div>
        
        <div class="features">
            <div class="feature">
                <strong>üéÆ Full 3D Controls</strong>
                WASD movement, mouse camera, real-time combat
            </div>
            <div class="feature">
                <strong>ü§ñ Predictive AI</strong>
                Enemies that learn and counter your playstyle
            </div>
            <div class="feature">
                <strong>‚öîÔ∏è Dynamic Combat</strong>
                Abilities, dash, shields, and explosive effects
            </div>
            <div class="feature">
                <strong>üåç Living World</strong>
                Environment reacts to your decisions
            </div>
        </div>

        <div style="margin: 30px auto; padding: 20px; background: rgba(255, 170, 0, 0.2); border: 2px solid #ffaa00; border-radius: 10px; max-width: 600px;">
            <p style="font-size: 14px; margin-bottom: 10px; color: #ffaa00; font-weight: bold;">‚ö†Ô∏è Important: Disable Ad Blockers</p>
            <p style="font-size: 13px; line-height: 1.5;">
                This game loads 3D assets from external sources. Please disable all ad blockers or open in Chrome Incognito (extensions off) / Firefox with no addons for the best experience.
            </p>
        </div>

        <button id="start-btn">ENTER THE WORLD</button>
        
        <div style="margin-top: 30px; font-size: 12px; opacity: 0.6;">
            <p>This is a fully 3D game experience. No static buttons.</p>
            <p>All interactions happen in real-time 3D space.</p>
        </div>
    </div>

    <!-- Back to Menu Button -->
    <a href="/index.html" id="back-to-menu">‚Üê Back to Menu</a>

    <!-- Load Three.js from local npm package -->
    <script src="/three/three.min.js"></script>
    
    <!-- Load GLTFLoader and Cannon Physics (ES Modules) -->
    <script type="module" src="/lib/loaders-bundle.js"></script>
    <script type="module" src="/lib/cannon-bundle.js"></script>

    <!-- Load new Conscience Engine systems -->
    <script src="/intent-tracker.js"></script>
    <script src="/world-reactions.js"></script>
    <script src="/powerup-system.js"></script>
    <script src="/enemy-system.js"></script>
    <script src="/death-screen.js"></script>
    <script src="/vertical-map-generator.js"></script>

    <!-- Game will be injected here -->
    <script>
        // Game3D class will be defined inline since we can't use modules with global THREE
        let game = null;
        let playerId = null;

        // Wait for Three.js to load
        function waitForThree() {
            return new Promise((resolve) => {
                if (window.THREE) {
                    resolve();
                } else {
                    setTimeout(() => waitForThree().then(resolve), 100);
                }
            });
        }

        // Hide loading screen and show start overlay
        window.addEventListener('load', async () => {
            await waitForThree();
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('start-overlay').classList.remove('hidden');
            }, 1000);
        });

        // Start game button
        document.getElementById('start-btn').addEventListener('click', async () => {
            document.getElementById('start-overlay').classList.add('hidden');
            document.getElementById('back-to-menu').style.display = 'block';
            
            // Initialize game session with backend
            try {
                const response = await fetch('/api/session/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                playerId = data.playerId;
                
                console.log('Game session started:', playerId);
            } catch (error) {
                console.error('Failed to start game session:', error);
                // Continue anyway for offline demo
            }

            // Load and initialize 3D game
            const script = document.createElement('script');
            script.src = '/game3d.js';
            script.onload = async () => {
                game = new window.Game3D();
                await game.init();
                
                console.log('3D Game initialized');
                
                // Hook into game actions to send to backend
                const originalUseAbility = game.useAbility.bind(game);
                game.useAbility = async function(index) {
                    originalUseAbility(index);
                    
                    if (playerId) {
                        try {
                            const abilityTypes = ['attack', 'defend', 'plan', 'explore'];
                            const action = {
                                type: abilityTypes[index] || 'attack',
                                timestamp: Date.now(),
                                context: '3d_game'
                            };
                            
                            await fetch('/api/action', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ playerId, action })
                            });
                        } catch (error) {
                            console.error('Failed to sync action with backend:', error);
                        }
                    }
                };
            };
            document.body.appendChild(script);
        });

        // Prevent accidental page navigation
        window.addEventListener('beforeunload', (e) => {
            if (game && !game.paused) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
